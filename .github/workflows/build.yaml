name: Build Metabase Flink SQL Driver

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flink-version: ['1.18', '1.19', '1.20', '2.1']
      fail-fast: false

    steps:
    - name: Checkout driver code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Set up Clojure
      uses: DeLaGuardo/setup-clojure@12.3
      with:
        cli: latest

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-flink-${{ matrix.flink-version }}-${{ hashFiles('**/deps.edn') }}
        restore-keys: |
          ${{ runner.os }}-maven-flink-${{ matrix.flink-version }}-
          ${{ runner.os }}-maven-

    - name: Build driver JAR for Flink ${{ matrix.flink-version }}
      run: |
        echo "Building Metabase Flink SQL Driver for Flink ${{ matrix.flink-version }}..."
        clojure -T:build uber :flink-version '"${{ matrix.flink-version }}"'
        echo "Build complete!"
        ls -la target/*.jar

    - name: Verify JAR contents
      run: |
        echo "Verifying JAR structure..."
        JAR_FILE=$(ls target/*.jar | head -1)
        jar tf "$JAR_FILE" | head -50
        echo "..."
        jar tf "$JAR_FILE" | grep -E "(metabase-plugin\.yaml|flink_sql\.clj)" || echo "Warning: Expected files not found"

    - name: Upload driver artifact
      uses: actions/upload-artifact@v4
      with:
        name: metabase-flink-driver-flink-${{ matrix.flink-version }}
        path: target/*.jar
        if-no-files-found: error

  # Integration test job - tests with matching Flink version
  test:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        include:
          - flink-version: '2.1'
            flink-image: 'flink:2.1.1-java17'
      fail-fast: false
    # Only run integration tests on main branch to save CI time
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: metabase
          POSTGRES_PASSWORD: metabase
          POSTGRES_DB: metabase
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download driver artifact
      uses: actions/download-artifact@v4
      with:
        name: metabase-flink-driver-flink-${{ matrix.flink-version }}
        path: ./plugins/

    - name: Start Flink cluster (version ${{ matrix.flink-version }})
      run: |
        # Pull and start Flink services
        docker network create flink-net || true

        # Start JobManager
        docker run -d --name jobmanager \
          --network flink-net \
          -p 8081:8081 \
          -e FLINK_PROPERTIES="jobmanager.rpc.address: jobmanager" \
          ${{ matrix.flink-image }} jobmanager

        # Wait for JobManager
        echo "Waiting for JobManager..."
        for i in {1..30}; do
          if curl -s -f http://localhost:8081/overview >/dev/null 2>&1; then
            echo "JobManager is ready!"
            break
          fi
          sleep 2
        done

        # Start TaskManager
        docker run -d --name taskmanager \
          --network flink-net \
          -e FLINK_PROPERTIES="jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 4" \
          ${{ matrix.flink-image }} taskmanager

        # Start SQL Gateway
        docker run -d --name sql-gateway \
          --network flink-net \
          -p 8083:8083 \
          ${{ matrix.flink-image }} \
          bash -c "sleep 10 && /opt/flink/bin/sql-gateway.sh start-foreground \
            -Dsql-gateway.endpoint.rest.address=0.0.0.0 \
            -Dsql-gateway.endpoint.rest.port=8083 \
            -Djobmanager.rpc.address=jobmanager \
            -Drest.address=jobmanager"

        # Wait for SQL Gateway
        echo "Waiting for SQL Gateway..."
        for i in {1..30}; do
          if curl -s -f http://localhost:8083/v1/info >/dev/null 2>&1; then
            echo "SQL Gateway is ready!"
            break
          fi
          sleep 2
        done

    - name: Start Metabase with driver
      run: |
        docker run -d --name metabase \
          --network flink-net \
          -p 3000:3000 \
          -v ${{ github.workspace }}/plugins:/plugins \
          -e MB_DB_TYPE=postgres \
          -e MB_DB_HOST=host.docker.internal \
          -e MB_DB_PORT=5432 \
          -e MB_DB_DBNAME=metabase \
          -e MB_DB_USER=metabase \
          -e MB_DB_PASS=metabase \
          -e MB_PLUGINS_DIR=/plugins \
          --add-host=host.docker.internal:host-gateway \
          metabase/metabase:v0.57.7

        # Wait for Metabase
        echo "Waiting for Metabase..."
        for i in {1..60}; do
          if curl -s -f http://localhost:3000/api/health >/dev/null 2>&1; then
            echo "Metabase is ready!"
            break
          fi
          echo "Attempt $i..."
          sleep 5
        done

    - name: Verify driver loaded
      run: |
        # Check Metabase logs for driver loading
        docker logs metabase 2>&1 | grep -i "flink" || true

        # Check available drivers via API
        curl -s http://localhost:3000/api/session/properties | python3 -c "
        import sys, json
        data = json.load(sys.stdin)
        engines = data.get('engines', {})
        if 'flink-sql' in engines:
            print('SUCCESS: Flink SQL driver is available!')
            print(json.dumps(engines['flink-sql'], indent=2))
        else:
            print('WARNING: Flink SQL driver not found in available engines')
            print('Available engines:', list(engines.keys())[:10])
        "

    - name: Cleanup
      if: always()
      run: |
        docker stop metabase sql-gateway taskmanager jobmanager || true
        docker rm metabase sql-gateway taskmanager jobmanager || true
        docker network rm flink-net || true

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
    - name: Checkout driver code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts/

    - name: Prepare release artifacts
      run: |
        echo "Downloaded artifacts:"
        find ./artifacts -name "*.jar" -type f

        # Move all JARs to a single directory
        mkdir -p ./release-jars
        find ./artifacts -name "*.jar" -type f -exec cp {} ./release-jars/ \;

        echo "Release JARs:"
        ls -la ./release-jars/

    - name: Create release tag and upload artifacts
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Fetch all tags
        git fetch --tags

        # Get the latest tag (assume semantic versioning)
        LATEST_TAG=$(git tag -l | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)

        if [ -z "$LATEST_TAG" ]; then
          # No existing tags, start with 0.0.1
          NEW_TAG="0.0.1"
        else
          # Extract version parts
          IFS='.' read -ra VERSION_PARTS <<< "$LATEST_TAG"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          # Increment patch version
          PATCH=$((PATCH + 1))
          NEW_TAG="$MAJOR.$MINOR.$PATCH"
        fi

        # Configure git
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

        # Create and push tag
        git tag $NEW_TAG
        git push origin $NEW_TAG

        echo "Created tag: $NEW_TAG (previous: $LATEST_TAG)"

        # Create release notes file
        cat > release_notes.md << 'RELEASE_NOTES_EOF'
        ## Metabase Flink SQL Driver

        ### Download the JAR for your Flink version

        | Your Flink Version | Download |
        |-------------------|----------|
        | Flink 1.18.x | `metabase-flink-driver-1.0.0-flink-1.18.jar` |
        | Flink 1.19.x | `metabase-flink-driver-1.0.0-flink-1.19.jar` |
        | Flink 1.20.x | `metabase-flink-driver-1.0.0-flink-1.20.jar` |
        | Flink 2.0.x / 2.1.x | `metabase-flink-driver-1.0.0-flink-2.1.jar` |

        ### Installation
        1. Download the JAR matching your Flink SQL Gateway version
        2. Copy to your Metabase plugins directory
        3. Restart Metabase

        ### Compatibility
        - Metabase v0.50+ (tested with v0.57.7)
        - Apache Flink 1.18+ with SQL Gateway
        - Java 17+

        ### Features
        - Query Flink streaming and batch tables
        - Multi-catalog and multi-database support
        - DDL statement support (CREATE TABLE, DROP TABLE, etc.)
        - Full SQL support for bounded tables

        ---
        *Automated release from CI*
        RELEASE_NOTES_EOF

        # Create GitHub Release with all JARs
        gh release create $NEW_TAG \
          --title "Release $NEW_TAG" \
          --notes-file release_notes.md \
          ./release-jars/*.jar

        echo "Release $NEW_TAG created successfully with $(ls ./release-jars/*.jar | wc -l) JAR files!"
